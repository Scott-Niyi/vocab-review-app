# 验证文件持久化 - 测试步骤

## 目标

确认每次保存/修改单词时，数据都真正写入到 JSON 文件中，而不是 localStorage。

## 测试步骤

### 1. 启动应用

```bash
cd vocab-review-app
npm run dev
```

### 2. 选择或创建数据仓

应用启动后，你会看到"选择词汇表"界面：

- **创建新列表**：点击"✨ Create New List"，输入名称（例如："my-vocab"）
- **或选择已有列表**：如果有现有的列表，点击选择

### 3. 添加测试单词

1. 点击"Add Word"标签
2. 添加一个简单的单词，例如：
   - Word: `test`
   - Definition: `A trial or examination`
3. 点击"Add to Library"

### 4. 立即验证文件

**打开新终端**，运行：

```bash
# 查看文件内容
cat ~/Library/Application\ Support/Electron/user-data/my-vocab.json

# 或者用 jq 格式化查看（如果安装了 jq）
cat ~/Library/Application\ Support/Electron/user-data/my-vocab.json | jq .
```

**期望结果**：
- ✅ 文件存在
- ✅ 包含你刚添加的单词
- ✅ 有 `lastModified` 时间戳
- ✅ 有 `userIdCounter` 字段

### 5. 修改单词并验证

1. 在应用中，进入"Library"标签
2. 选择你刚添加的单词
3. 点击"Edit"
4. 修改定义，例如改为：`A trial or examination (modified)`
5. 保存

**立即检查文件**：

```bash
cat ~/Library/Application\ Support/Electron/user-data/my-vocab.json | grep "modified"
```

**期望结果**：
- ✅ 文件中的定义已更新
- ✅ `lastModified` 时间戳已更新

### 6. 复习单词并验证

1. 进入"Review"模式
2. 给单词打分（例如：5分）
3. **立即检查文件**：

```bash
cat ~/Library/Application\ Support/Electron/user-data/my-vocab.json | jq '.vocabulary[] | select(.word=="test") | {timesReviewed, familiarityScore}'
```

**期望结果**：
- ✅ `timesReviewed` 增加了
- ✅ `familiarityScore` 更新了
- ✅ 文件的 `lastModified` 更新了

### 7. 测试持久化（关闭重开）

1. **完全关闭应用**（Cmd+Q）
2. **重新启动**：`npm run dev`
3. 应该自动加载你之前选择的词汇表
4. 检查你的单词是否还在，数据是否保留

**期望结果**：
- ✅ 单词还在
- ✅ 复习统计保留
- ✅ 所有修改都保留

### 8. 测试多个数据仓

1. 打开 Settings
2. 点击"📚 Switch List"
3. 创建新的词汇表（例如："gre-vocab"）
4. 添加不同的单词
5. 检查两个文件都存在：

```bash
ls -la ~/Library/Application\ Support/Electron/user-data/*.json
```

**期望结果**：
- ✅ 看到多个 JSON 文件
- ✅ 每个文件独立存储数据
- ✅ 可以在它们之间切换

## 验证脚本

运行这个脚本来自动检查：

```bash
#!/bin/bash

DATA_DIR=~/Library/Application\ Support/Electron/user-data

echo "🔍 检查数据文件..."
echo ""

if [ ! -d "$DATA_DIR" ]; then
    echo "❌ 数据目录不存在: $DATA_DIR"
    exit 1
fi

echo "✅ 数据目录存在: $DATA_DIR"
echo ""

JSON_FILES=$(find "$DATA_DIR" -name "*.json" 2>/dev/null)

if [ -z "$JSON_FILES" ]; then
    echo "⚠️  没有找到 JSON 文件"
    echo "   请先在应用中添加一个单词"
    exit 0
fi

echo "📁 找到的数据文件："
echo "$JSON_FILES"
echo ""

for file in $JSON_FILES; do
    echo "📄 文件: $(basename "$file")"
    
    # 检查是否是有效的 JSON
    if jq empty "$file" 2>/dev/null; then
        echo "   ✅ 有效的 JSON 格式"
        
        # 获取单词数量
        word_count=$(jq '.vocabulary | length' "$file")
        echo "   📚 单词数量: $word_count"
        
        # 获取最后修改时间
        last_modified=$(jq -r '.lastModified' "$file")
        echo "   🕐 最后修改: $last_modified"
        
        # 获取版本
        version=$(jq -r '.version' "$file")
        echo "   📌 版本: $version"
    else
        echo "   ❌ 无效的 JSON 格式！"
    fi
    echo ""
done

echo "✅ 验证完成！"
```

保存为 `check-persistence.sh`，然后运行：

```bash
chmod +x check-persistence.sh
./check-persistence.sh
```

## 常见问题

### Q: 文件不存在？
**A**: 
1. 确保运行的是 `npm run dev`（Electron 模式）
2. 确保已经添加了至少一个单词
3. 检查是否有错误信息在控制台

### Q: 数据没有更新？
**A**:
1. 检查 DevTools 控制台是否有错误
2. 确认 `window.electronAPI` 存在
3. 查看文件的 `lastModified` 时间戳

### Q: 还在使用 localStorage？
**A**:
1. 在 DevTools 控制台运行：
   ```javascript
   console.log('Electron API:', !!window.electronAPI);
   console.log('Data Store:', window.electronAPI?.fs);
   ```
2. 应该看到 `true` 和文件系统 API 对象

## 成功标准

✅ 每次添加单词，文件立即更新
✅ 每次修改单词，文件立即更新
✅ 每次复习单词，统计数据立即写入文件
✅ 关闭重开后，所有数据保留
✅ 可以创建和切换多个词汇表
✅ 每个词汇表独立存储在不同的 JSON 文件中
✅ 不使用 localStorage 存储词汇数据（只用来记住选择的文件名）

## 下一步

如果所有测试通过：
1. 🎉 文件持久化工作正常！
2. 可以开始正常使用应用
3. 定期导出备份（Settings → Export Backup）
4. 可以创建多个词汇表来组织不同类型的单词

如果测试失败：
1. 检查控制台错误信息
2. 运行 `./verify-setup.sh` 检查配置
3. 查看 `FILE-PERSISTENCE-COMPLETE.md` 了解架构
