# 数据仓（词汇表）功能说明

## 新功能概述

现在你的应用支持**多个独立的词汇表**（数据仓），每个词汇表存储在独立的 JSON 文件中。

## 主要特性

### ✅ 1. 启动时选择数据仓

- 应用启动时，会显示"选择词汇表"界面
- 可以选择已有的词汇表
- 可以创建新的词汇表
- 可以浏览文件系统选择 JSON 文件

### ✅ 2. 真正的文件持久化

- **每次操作都立即写入文件**：
  - 添加单词 → 立即保存到文件
  - 修改单词 → 立即更新文件
  - 复习单词 → 立即更新统计数据到文件
  - 删除单词 → 立即从文件中删除

- **不使用 localStorage 存储词汇数据**：
  - localStorage 只用来记住你选择的文件名
  - 所有词汇数据都在 JSON 文件中

### ✅ 3. 多个独立的词汇表

- 可以创建多个词汇表，例如：
  - `gre-vocab.json` - GRE 单词
  - `toefl-vocab.json` - TOEFL 单词
  - `daily-reading.json` - 日常阅读单词
  - `technical-terms.json` - 技术术语

- 每个词汇表完全独立：
  - 独立的单词列表
  - 独立的复习统计
  - 独立的 ID 计数器

### ✅ 4. 随时切换词汇表

- 在 Settings 中点击"📚 Switch List"
- 选择不同的词汇表
- 当前数据会自动保存

## 使用流程

### 首次使用

```bash
# 1. 启动应用
npm run dev

# 2. 看到"选择词汇表"界面
# 3. 点击"✨ Create New List"
# 4. 输入名称，例如："my-vocabulary"
# 5. 开始添加单词！
```

### 创建多个词汇表

```bash
# 1. 打开 Settings
# 2. 点击"📚 Switch List"
# 3. 点击"✨ Create New List"
# 4. 输入新名称，例如："gre-words"
# 5. 现在你有两个独立的词汇表了！
```

### 在词汇表之间切换

```bash
# 1. 打开 Settings
# 2. 点击"📚 Switch List"
# 3. 选择你想要的词汇表
# 4. 应用会重新加载选中的词汇表
```

## 数据存储位置

所有词汇表文件存储在：

```
~/Library/Application Support/Electron/user-data/
├── my-vocabulary.json
├── gre-words.json
├── toefl-words.json
└── technical-terms.json
```

## 文件格式

每个 JSON 文件包含：

```json
{
  "vocabulary": [
    {
      "id": 1001,
      "word": "test",
      "ipa": "/test/",
      "respelling": "TEST",
      "definitions": [...],
      "examples": [...],
      "familiarityScore": 50,
      "timesReviewed": 3,
      "timesCorrect": 2
    }
  ],
  "version": 4,
  "lastModified": "2026-01-31T12:34:56.789Z",
  "userIdCounter": 1002
}
```

## 验证持久化

### 快速验证

```bash
# 1. 添加一个单词
# 2. 立即运行：
cat ~/Library/Application\ Support/Electron/user-data/my-vocabulary.json

# 你应该立即看到你的单词！
```

### 详细验证

参见 [验证文件持久化.md](./验证文件持久化.md)

### 自动检查脚本

```bash
./check-persistence.sh
```

## 实时监控文件变化

想看到文件实时更新？运行：

```bash
# 安装 watch（如果没有）
brew install watch

# 实时监控文件的最后修改时间
watch -n 1 "cat ~/Library/Application\ Support/Electron/user-data/my-vocabulary.json | jq .lastModified"

# 或者监控单词数量
watch -n 1 "cat ~/Library/Application\ Support/Electron/user-data/my-vocabulary.json | jq '.vocabulary | length'"
```

然后在应用中添加/修改单词，你会看到文件立即更新！

## 备份和迁移

### 导出备份

1. 打开 Settings
2. 点击"Export Backup"
3. 选择保存位置
4. 文件名格式：`vocabulary-backup-2026-01-31.json`

### 导入数据

1. 打开 Settings
2. 点击"Import Data"
3. 选择之前导出的 JSON 文件
4. 数据会合并到当前词汇表

### 手动备份

```bash
# 备份所有词汇表
cp -r ~/Library/Application\ Support/Electron/user-data ~/Desktop/vocab-backup

# 恢复备份
cp ~/Desktop/vocab-backup/*.json ~/Library/Application\ Support/Electron/user-data/
```

## 常见问题

### Q: 数据真的立即保存了吗？

**A**: 是的！每次操作都会调用 `saveToFile()`。你可以：

1. 打开两个终端窗口
2. 一个运行应用
3. 另一个运行：`watch -n 1 "ls -la ~/Library/Application\ Support/Electron/user-data/*.json"`
4. 添加单词时，你会看到文件大小和修改时间立即变化

### Q: 如果我不选择文件会怎样？

**A**: 应用会一直显示"选择词汇表"界面，直到你选择或创建一个。

### Q: 可以在不同电脑间共享词汇表吗？

**A**: 可以！方法：

1. 导出词汇表（Settings → Export Backup）
2. 通过云盘/U盘/邮件传输 JSON 文件
3. 在另一台电脑上导入（Settings → Import Data）

或者直接复制 JSON 文件到另一台电脑的数据目录。

### Q: 词汇表文件可以手动编辑吗？

**A**: 可以，但要小心：

1. 确保 JSON 格式正确
2. 不要修改 `id` 字段（会导致冲突）
3. 保持 `version` 和 `userIdCounter` 字段
4. 建议先备份再编辑

### Q: 如何删除一个词汇表？

**A**: 

```bash
# 列出所有词汇表
ls ~/Library/Application\ Support/Electron/user-data/*.json

# 删除指定的词汇表
rm ~/Library/Application\ Support/Electron/user-data/old-vocab.json
```

## 技术细节

### 文件写入时机

```typescript
// 每次这些操作都会立即调用 saveToFile()
await dataStore.addWord(entry);      // ✅ 立即保存
await dataStore.updateWord(entry);   // ✅ 立即保存
await dataStore.deleteWord(id);      // ✅ 立即保存
await dataStore.recordReview(id, 5); // ✅ 立即保存
```

### 文件写入实现

```typescript
private async saveToFile(): Promise<void> {
  const data: VocabularyData = {
    vocabulary: this.vocabulary,
    version: MOCK_DATA_VERSION,
    lastModified: new Date().toISOString(), // 时间戳
    userIdCounter: this.userIdCounter,
  };

  const electronAPI = (window as any).electronAPI;
  const writeResult = await electronAPI.fs.writeFile(
    this.dataFileName,
    JSON.stringify(data, null, 2) // 格式化的 JSON
  );
}
```

### Electron IPC

```typescript
// Main process (electron/main.ts)
ipcMain.handle('fs:writeFile', async (event, filePath, content) => {
  const fullPath = path.join(USER_DATA_DIR, filePath);
  fs.writeFileSync(fullPath, content, 'utf-8'); // 同步写入
  return { success: true };
});
```

## 总结

✅ **数据仓（词汇表）功能已完成**
✅ **每次操作都立即持久化到文件**
✅ **支持多个独立的词汇表**
✅ **可以随时切换词汇表**
✅ **不使用 localStorage 存储词汇数据**
✅ **文件格式清晰，易于备份和迁移**

现在你可以：
1. 创建多个词汇表来组织不同类型的单词
2. 确信每次操作都真正保存到文件中
3. 轻松备份和迁移你的词汇数据
4. 在不同电脑间共享词汇表

开始使用吧！🎉
